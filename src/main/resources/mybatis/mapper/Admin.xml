<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.admin">
    <!--관리자 리스트 -->
    <select id="adminList" resultType="Admin">
        select @ROWNUM:=@ROWNUM+1 as ROWNUM
        ,  SEQ
        , ID
        , M.NAME
        , MEMBER_TYPE
        , EMAIL
        , REG_DT
        , UPD_DT
        , UPD_NM
        , REG_NM
        , WHDWL_YMD
        from itkey_dev.`member` M
        where (@ROWNUM:=0)=0
        <include refid="search"></include>
        and USE_YN = 'Y'
        order by ROWNUM DESC
    </select>

    <!-- 관리자 카운트-->
    <select id="countAdmin" resultType="_int">
        SELECT
                COUNT(*)
        FROM
                MEMBER
        WHERE
                USE_YN ='Y';
    </select>

    <!-- 관리자 추가 -->
    <insert id="insertAdmin" parameterType="Admin">
       INSERT INTO MEMBER(ID, PASSWORD, NAME, HP, EMAIL, MEMBER_TYPE, AUTH_CODE, USE_YN, REG_ID, REG_NM, REG_DT)
       VALUES (#{id}, #{password}, #{name}, #{hp}, #{email}, #{memberType}, #{authCode}, 'Y', #{regId}, #{regNm}, now());
    </insert>
    <!-- 관리자 아이디 중복 체크-->
    <select id="adminIdCheck" parameterType="String" resultType="_int">
        SELECT
            COUNT(*)
        FROM
            MEMBER
        WHERE
            ID = #{id}
    </select>
    <!-- 로그인 유저 정보 가져오기 -->
    <select id="getLoginInfo" parameterType="_int" resultType="TotalAdminDTO">
        SELECT *
        FROM
                MEMBER
        WHERE
            SEQ = #{adminIdx}
    </select>

    <!-- 관리자 Y>N 변경(탈퇴) -->
    <update id="deleteAdmin" parameterType="Admin">
        UPDATE
                MEMBER
        <trim prefix="SET" prefixOverrides=",">
            <if test="updId       !=null and updId    !=''">, UPD_ID = #{updId} </if>
            <if test="updNm       !=null and updNm   !=''">, UPD_NM = #{updNm}</if>
        </trim>
        ,USE_YN = 'N'
        ,WHDWL_YMD = NOW()

        WHERE
            SEQ = #{seq}
    </update>

    <!--관리자 정보 수정 -->
    <update id="updateAdmin" parameterType="Admin">
        UPDATE
                MEMBER
        <trim prefix="SET" prefixOverrides=",">
            <if test="password        !=null and password    !=''">PASSWORD = #{password}</if>
            <if test="hp         !=null and hp     !=''">,HP = #{hp}</if>
            <if test="email         !=null and email     !=''">,EMAIL = #{email}</if>
            <if test="memberType         !=null and memberType     !=''">,MEMBER_TYPE = #{memberType}</if>
            <if test="useYn        !=null and useYn     !=''"> USE_YN = 'N'</if>
            <if test="updId       !=null and updId    !=''">, UPD_ID = #{updId}</if>
            <if test="updNm       !=null and updNm   !=''">, UPD_NM = #{updNm}</if>
        </trim>
        ,UPD_DT = NOW()
        WHERE
            SEQ = #{seq}
    </update>

    <!--탈퇴 관리자 리스트(useYN:N) -->
    <select id="del_adminList" resultType="Admin">
        select @ROWNUM:=@ROWNUM+1 as ROWNUM
        ,  SEQ
        , ID
        , M.NAME
        , MEMBER_TYPE
        , EMAIL
        , REG_DT
        , UPD_DT
        , UPD_NM
        , REG_NM
        , WHDWL_YMD
        from itkey_dev.`member` M
        where (@ROWNUM:=0)=0
        <include refid="search"></include>
        and USE_YN = 'N'
        order by ROWNUM DESC
    </select>

    <!--탈퇴 관리자 카운트 -->
    <select id="countDelAdmin" resultType="_int">
        SELECT
            COUNT(*)
        FROM
            MEMBER
        WHERE
            USE_YN ='N';
    </select>

    <!--탈퇴자 복귀 -->
    <update id="returnAdmin" parameterType="Admin">
        UPDATE
        MEMBER
        <trim prefix="SET" prefixOverrides=",">
            <if test="updId       !=null and updId    !=''">, UPD_ID = #{updId} </if>
            <if test="updNm       !=null and updNm   !=''">, UPD_NM = #{updNm}</if>
        </trim>
        ,USE_YN = 'Y'
        ,WHDWL_YMD = null
        WHERE
        SEQ = #{seq}
    </update>

    <!-- 영구 탈퇴 -->
    <delete id="realDeleteAdmin" parameterType="_int">
        DELETE
        FROM
             MEMBER
        WHERE
            SEQ = #{adminIdx}
    </delete>


    <!-- 검색 기능 -->
    <sql id="search">
        <choose>
            <when test="type == 'all'">
                AND (M.NAME LIKE CONCAT('%',#{keyword},'%')
                OR  M.ID LIKE CONCAT('%',#{keyword},'%'))
                AND  M.NAME  IS NOT NULL
            </when>
            <when test="type == 'name'">
                AND M.NAME LIKE CONCAT('%',#{keyword},'%')
            </when>
            <when test="type == 'id'">
                AND M.ID LIKE CONCAT('%',#{keyword},'%')
            </when>
        </choose>
    </sql>

</mapper>